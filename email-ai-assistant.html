<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MailMind ‚Äî AI Email Assistant</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --bg:       #0b0e14;
    --surface:  #111520;
    --panel:    #161b28;
    --border:   #1e2639;
    --accent:   #3b6ef8;
    --accent2:  #00d4aa;
    --danger:   #ff4f4f;
    --warn:     #f5a623;
    --text:     #e8ecf5;
    --muted:    #5a6380;
    --subtle:   #232b40;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  .app { position: relative; z-index: 1; display: grid; grid-template-rows: 56px 1fr; height: 100vh; overflow: hidden; }
  #emailView { display: grid; grid-template-columns: 320px 1fr 380px; height: 100%; overflow: hidden; }
  #blastView { display: none; grid-template-columns: 300px 1fr 400px; height: 100%; overflow: hidden; }

  /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 28px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon {
    width: 28px; height: 28px;
    background: var(--accent);
    clip-path: polygon(0 20%, 50% 0%, 100% 20%, 100% 80%, 50% 100%, 0 80%);
    display: flex; align-items: center; justify-content: center;
  }
  .logo-text { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 18px; letter-spacing: -0.5px; }
  .logo-text span { color: var(--accent); }
  .header-status { display: flex; align-items: center; gap: 20px; }
  .status-pill {
    display: flex; align-items: center; gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    background: var(--subtle);
    font-size: 11px;
    color: var(--muted);
    border: 1px solid var(--border);
  }
  .status-pill .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); }
  .status-pill.connected { color: var(--accent2); border-color: var(--accent2); background: rgba(0,212,170,0.08); }
  .status-pill.connected .dot { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }

  /* ‚îÄ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ */
  main { display: grid; grid-template-columns: 320px 1fr 380px; overflow: hidden; }
  .pane {
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    overflow: hidden;
  }
  .pane:last-child { border-right: none; }
  .pane-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    background: var(--surface);
    flex-shrink: 0;
  }
  .pane-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .pane-body { flex: 1; overflow-y: auto; padding: 16px; }
  .pane-body::-webkit-scrollbar { width: 4px; }
  .pane-body::-webkit-scrollbar-track { background: transparent; }
  .pane-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* ‚îÄ‚îÄ‚îÄ Setup Panel ‚îÄ‚îÄ‚îÄ */
  .setup-section { margin-bottom: 24px; }
  .setup-label {
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
    display: block;
  }
  input, textarea, select {
    width: 100%;
    background: var(--subtle);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    padding: 9px 12px;
    border-radius: 6px;
    outline: none;
    transition: border-color 0.2s;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--accent); }
  textarea { resize: vertical; min-height: 80px; }
  select option { background: var(--panel); }

  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 7px;
    padding: 9px 18px;
    border-radius: 6px;
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
    white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover:not(:disabled) { background: #5580ff; transform: translateY(-1px); }
  .btn-secondary { background: var(--subtle); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
  .btn-success { background: var(--accent2); color: #000; }
  .btn-success:hover:not(:disabled) { background: #00f0c3; }
  .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
  .btn-danger:hover:not(:disabled) { background: rgba(255,79,79,0.1); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
  .btn-sm { padding: 5px 12px; font-size: 11px; }
  .btn-full { width: 100%; }

  /* ‚îÄ‚îÄ‚îÄ Step badges ‚îÄ‚îÄ‚îÄ */
  .step-row { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 20px; }
  .step-num {
    width: 24px; height: 24px; flex-shrink: 0;
    background: var(--accent);
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif;
    font-weight: 800; font-size: 12px;
  }
  .step-content { flex: 1; }
  .step-title { font-size: 12px; font-weight: 500; color: var(--text); margin-bottom: 4px; }
  .step-desc { font-size: 11px; color: var(--muted); line-height: 1.5; }
  .step-desc a { color: var(--accent); text-decoration: none; }
  .step-desc a:hover { text-decoration: underline; }

  /* ‚îÄ‚îÄ‚îÄ Email list ‚îÄ‚îÄ‚îÄ */
  .email-item {
    padding: 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.15s;
    background: var(--panel);
    position: relative;
  }
  .email-item:hover { border-color: var(--accent); background: var(--subtle); }
  .email-item.selected { border-color: var(--accent); background: rgba(59,110,248,0.08); }
  .email-item.selected::before {
    content: '‚úì';
    position: absolute; top: 10px; right: 12px;
    color: var(--accent); font-size: 13px;
  }
  .email-from { font-size: 12px; font-weight: 500; color: var(--text); margin-bottom: 3px; }
  .email-subject { font-size: 11px; color: var(--accent2); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .email-preview { font-size: 10px; color: var(--muted); line-height: 1.4; overflow: hidden; max-height: 32px; }
  .email-meta { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .email-date { font-size: 10px; color: var(--muted); }
  .email-badge {
    font-size: 9px; letter-spacing: 1px; text-transform: uppercase;
    padding: 2px 6px; border-radius: 3px;
    background: var(--subtle); color: var(--muted);
    border: 1px solid var(--border);
  }

  /* ‚îÄ‚îÄ‚îÄ Empty states ‚îÄ‚îÄ‚îÄ */
  .empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 200px; gap: 12px; color: var(--muted); text-align: center;
  }
  .empty-icon { font-size: 32px; opacity: 0.3; }
  .empty-text { font-size: 11px; line-height: 1.5; }

  /* ‚îÄ‚îÄ‚îÄ Draft panel ‚îÄ‚îÄ‚îÄ */
  .draft-field { margin-bottom: 16px; }
  .draft-field label { display: block; font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }

  .ai-thinking {
    display: flex; align-items: center; gap: 10px;
    padding: 16px; border-radius: 8px;
    background: rgba(59,110,248,0.08);
    border: 1px solid rgba(59,110,248,0.25);
    margin-bottom: 16px;
  }
  .thinking-dots span {
    display: inline-block; width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent); margin: 0 2px;
    animation: bounce 1.2s infinite;
  }
  .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { 0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)} }

  .send-row { display: flex; gap: 10px; margin-top: 16px; }

  /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--panel); border: 1px solid var(--border);
    color: var(--text); padding: 10px 20px;
    border-radius: 8px; font-size: 12px;
    opacity: 0; transition: all 0.3s; z-index: 1000;
    pointer-events: none;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  #toast.success { border-color: var(--accent2); color: var(--accent2); }
  #toast.error { border-color: var(--danger); color: var(--danger); }

  /* ‚îÄ‚îÄ‚îÄ Tag badges ‚îÄ‚îÄ‚îÄ */
  .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; letter-spacing: 0.5px; background: var(--subtle); color: var(--muted); border: 1px solid var(--border); margin: 2px; cursor: default; }

  /* ‚îÄ‚îÄ‚îÄ Selected count bar ‚îÄ‚îÄ‚îÄ */
  .sel-bar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 16px;
    background: rgba(59,110,248,0.12);
    border-top: 1px solid rgba(59,110,248,0.3);
    flex-shrink: 0;
  }
  .sel-bar-text { font-size: 11px; color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ Prompt builder ‚îÄ‚îÄ‚îÄ */
  .prompt-chip-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .prompt-chip {
    padding: 4px 10px; border-radius: 20px; font-size: 11px;
    background: var(--subtle); border: 1px solid var(--border);
    color: var(--muted); cursor: pointer; transition: all 0.15s;
  }
  .prompt-chip:hover, .prompt-chip.active { background: rgba(59,110,248,0.15); border-color: var(--accent); color: var(--accent); }
  .prompt-chip-quote { border-color: var(--warn) !important; color: var(--warn) !important; background: rgba(245,166,35,0.08) !important; font-weight: 500; }
  .prompt-chip-quote:hover, .prompt-chip-quote.active { background: rgba(245,166,35,0.2) !important; box-shadow: 0 0 10px rgba(245,166,35,0.2); }

  .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

  .hint {
    font-size: 10px; color: var(--muted); line-height: 1.6;
    background: var(--subtle); border: 1px solid var(--border);
    border-radius: 6px; padding: 10px 12px;
    margin-bottom: 16px;
  }
  .hint strong { color: var(--warn); }

  /* loading spinner */
  .spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.2);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ‚îÄ Scrollbar (global) ‚îÄ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .filter-row { display: flex; gap: 8px; align-items: center; margin-bottom: 14px; }
  .filter-row input { flex: 1; }

  /* ‚îÄ‚îÄ‚îÄ Tab Nav ‚îÄ‚îÄ‚îÄ */
  .tab-nav { display: flex; align-items: center; gap: 4px; }
  .tab-btn {
    padding: 6px 16px; border-radius: 6px; border: 1px solid transparent;
    font-family: 'DM Mono', monospace; font-size: 11px; cursor: pointer;
    color: var(--muted); background: transparent; transition: all 0.15s;
    letter-spacing: 0.3px;
  }
  .tab-btn:hover { color: var(--text); border-color: var(--border); }
  .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .tab-btn.blast-tab.active { background: var(--warn); border-color: var(--warn); color: #000; }

  /* ‚îÄ‚îÄ‚îÄ Operator Blast Layout ‚îÄ‚îÄ‚îÄ */

  /* ‚îÄ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ‚îÄ */
  .drop-zone {
    border: 2px dashed var(--border); border-radius: 10px;
    padding: 28px 16px; text-align: center; cursor: pointer;
    transition: all 0.2s; margin-bottom: 16px;
    background: var(--panel);
  }
  .drop-zone:hover, .drop-zone.dragover { border-color: var(--warn); background: rgba(245,166,35,0.06); }
  .drop-zone-icon { font-size: 28px; margin-bottom: 8px; }
  .drop-zone-text { font-size: 11px; color: var(--muted); line-height: 1.5; }
  .drop-zone-text strong { color: var(--warn); }
  .drop-zone img { max-width: 100%; max-height: 160px; border-radius: 6px; margin-top: 10px; object-fit: contain; }

  /* ‚îÄ‚îÄ‚îÄ Operator match list ‚îÄ‚îÄ‚îÄ */
  .op-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 12px; border-radius: 6px;
    border: 1px solid var(--border); margin-bottom: 6px;
    background: var(--panel); cursor: pointer; transition: all 0.15s;
  }
  .op-item:hover { border-color: var(--warn); }
  .op-item.selected { border-color: var(--warn); background: rgba(245,166,35,0.08); }
  .op-item.selected .op-check { background: var(--warn); color: #000; }
  .op-check {
    width: 18px; height: 18px; border-radius: 4px; flex-shrink: 0;
    background: var(--subtle); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 700;
  }
  .op-name { font-size: 12px; color: var(--text); flex: 1; }
  .op-email { font-size: 10px; color: var(--muted); }
  .op-match-badge {
    font-size: 9px; padding: 2px 6px; border-radius: 3px;
    background: rgba(0,212,170,0.1); color: var(--accent2);
    border: 1px solid rgba(0,212,170,0.2); white-space: nowrap;
  }

  .blast-sel-bar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 16px; background: rgba(245,166,35,0.1);
    border-top: 1px solid rgba(245,166,35,0.3); flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ BCC tag display ‚îÄ‚îÄ‚îÄ */
  .bcc-box {
    background: var(--subtle); border: 1px solid var(--border);
    border-radius: 6px; padding: 8px; min-height: 50px;
    max-height: 120px; overflow-y: auto; margin-bottom: 4px;
    display: flex; flex-wrap: wrap; gap: 4px; align-content: flex-start;
  }
  .bcc-tag {
    background: rgba(245,166,35,0.12); border: 1px solid rgba(245,166,35,0.3);
    color: var(--warn); font-size: 10px; padding: 2px 8px; border-radius: 12px;
  }
</style>
</head>
<body>
<div class="app">

  <!-- ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ -->
  <header>
    <div class="logo">
      <div class="logo-icon"></div>
      <div class="logo-text">Mail<span>Mind</span></div>
    </div>
    <div class="tab-nav">
      <button class="tab-btn active" id="tabEmail" onclick="switchTab('email')">‚úâ Email Assistant</button>
      <button class="tab-btn blast-tab" id="tabBlast" onclick="switchTab('blast')">‚úà Operator Blast</button>
    </div>
    <div class="header-status">
      <div class="status-pill" id="outlookStatus"><span class="dot"></span>Outlook disconnected</div>
      <div class="status-pill" id="aiStatus"><span class="dot"></span>AI ready</div>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ‚îÄ Email Assistant View ‚îÄ‚îÄ‚îÄ -->
  <div id="emailView">

  <!-- ‚îÄ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ -->
  <main style="display:contents;">

    <!-- Pane 1: Setup & Config -->
    <div class="pane">
      <div class="pane-header">
        <div class="pane-title">‚öô Configuration</div>
      </div>
      <div class="pane-body">

        <!-- Step 1: Azure App -->
        <div class="setup-section">
          <div class="step-row">
            <div class="step-num">1</div>
            <div class="step-content">
              <div class="step-title">Azure App Registration</div>
              <div class="step-desc">
                Create a free app at <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps" target="_blank">portal.azure.com</a>.
                Under <strong>Authentication ‚Üí Add a platform ‚Üí Single-page application</strong>, add your redirect URI.
                Enable <strong>Access tokens</strong> and <strong>ID tokens</strong> checkboxes under implicit grant.
                Add <strong>Mail.Read</strong> + <strong>Mail.Send</strong> under API Permissions ‚Üí Microsoft Graph ‚Üí Delegated.
              </div>
            </div>
          </div>

          <label class="setup-label">Azure Client ID</label>
          <input type="text" id="clientId" value="bc20479b-d2bc-424a-85d3-718656921d45" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />

          <div style="margin-top: 10px;">
            <label class="setup-label">Redirect URI (this page)</label>
            <input type="text" id="redirectUri" placeholder="https://yourdomain.com/email-ai-assistant.html" />
          </div>
        </div>

        <hr class="divider" />

        <!-- Step 2: Claude API -->
        <div class="setup-section">
          <div class="step-row">
            <div class="step-num">2</div>
            <div class="step-content">
              <div class="step-title">Anthropic API Key</div>
              <div class="step-desc">Get your key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>. Stored only in memory ‚Äî never sent anywhere except Anthropic's API.</div>
            </div>
          </div>
          <input type="password" id="anthropicKey" placeholder="sk-ant-..." />
        </div>

        <hr class="divider" />

        <!-- Step 3: Connect -->
        <div class="setup-section">
          <div class="step-row">
            <div class="step-num">3</div>
            <div class="step-content">
              <div class="step-title">Connect & Fetch Emails</div>
              <div class="step-desc">Sign in with Microsoft to authorize inbox access.</div>
            </div>
          </div>
          <button class="btn btn-primary btn-full" id="connectBtn" onclick="connectOutlook()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M21.35 11.1H12.18V13.83H18.69C18.36 17.64 15.19 19.27 12.19 19.27C8.36 19.27 5 16.25 5 12C5 7.9 8.2 4.73 12.2 4.73C15.29 4.73 17.1 6.7 17.1 6.7L19 4.72C19 4.72 16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12C2.03 17.05 6.16 22 12.25 22C17.6 22 21.5 18.33 21.5 12.91C21.5 11.76 21.35 11.1 21.35 11.1Z"/></svg>
            Sign in with Microsoft
          </button>
          <button class="btn btn-secondary btn-full" id="signOutBtn" onclick="signOut()" style="margin-top:8px;display:none;">Sign Out</button>
        </div>

        <hr class="divider" />

        <!-- Fetch config -->
        <div class="setup-section">
          <label class="setup-label">Emails to fetch</label>
          <select id="fetchCount">
            <option value="10">Latest 10 emails</option>
            <option value="25" selected>Latest 25 emails</option>
            <option value="50">Latest 50 emails</option>
            <option value="100">Latest 100 emails</option>
          </select>
          <div style="margin-top: 10px;">
            <label class="setup-label">Filter by keyword (optional)</label>
            <input type="text" id="filterKeyword" placeholder="e.g. invoice, project, report" />
          </div>
          <button class="btn btn-secondary btn-full" style="margin-top:10px;" id="fetchBtn" onclick="fetchEmails()" disabled>
            Fetch Emails
          </button>
        </div>

      </div>
    </div>

    <!-- Pane 2: Email List -->
    <div class="pane">
      <div class="pane-header">
        <div class="pane-title">üì¨ Inbox</div>
        <div id="emailCount" style="font-size:11px;color:var(--muted);"></div>
      </div>
      <div class="pane-body" id="emailList">
        <div class="empty-state">
          <div class="empty-icon">üì≠</div>
          <div class="empty-text">Connect your Outlook account<br/>and fetch emails to get started</div>
        </div>
      </div>
      <div class="sel-bar" id="selBar" style="display:none;">
        <div class="sel-bar-text" id="selCount">0 emails selected</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear</button>
          <button class="btn btn-sm btn-primary" onclick="analyzeAndDraft()" id="draftBtn">
            Draft with AI ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Pane 3: AI Draft -->
    <div class="pane">
      <div class="pane-header">
        <div class="pane-title">‚ú¶ AI Draft</div>
      </div>
      <div class="pane-body">

        <!-- Prompt config -->
        <div class="draft-field">
          <label>What should AI do with these emails?</label>
          <div class="prompt-chip-row">
            <span class="prompt-chip" onclick="setTemplate('summarize')">Summarize & reply</span>
            <span class="prompt-chip" onclick="setTemplate('forward')">Forward summary</span>
            <span class="prompt-chip" onclick="setTemplate('actionitems')">Action items recap</span>
            <span class="prompt-chip" onclick="setTemplate('report')">Status report</span>
            <span class="prompt-chip prompt-chip-quote" onclick="setTemplate('clientquote')">‚úà Client Quote</span>
          </div>
          <textarea id="aiInstruction" style="margin-top:10px;" placeholder="Describe what to do: e.g. 'Read these emails and draft a summary email to my manager listing key requests and deadlines.'" rows="3"></textarea>
        </div>

        <div id="thinkingIndicator" style="display:none;" class="ai-thinking">
          <div class="thinking-dots"><span></span><span></span><span></span></div>
          <span style="font-size:11px;color:var(--accent);">Claude is analyzing your emails...</span>
        </div>

        <!-- Draft output -->
        <div id="draftOutput" style="display:none;">
          <!-- Backend calculations (quote mode) -->
          <div id="calcPanel" style="display:none; margin-bottom:16px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <span style="font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--warn);">üßÆ Backend Calculations (verify before sending)</span>
            </div>
            <textarea id="calcBody" rows="10" style="font-size:11px;background:rgba(245,166,35,0.05);border-color:rgba(245,166,35,0.3);color:var(--warn);opacity:0.85;" readonly></textarea>
          </div>
          <hr class="divider" />
          <div class="draft-field">
            <label>To</label>
            <input type="text" id="draftTo" placeholder="recipient@example.com" />
          </div>
          <div class="draft-field">
            <label>Subject</label>
            <input type="text" id="draftSubject" />
          </div>
          <div class="draft-field">
            <label>Body</label>
            <textarea id="draftBody" rows="12"></textarea>
          </div>

          <div class="send-row">
            <button class="btn btn-success" style="flex:1;" onclick="sendEmail()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
              Send via Outlook
            </button>
            <button class="btn btn-secondary btn-sm" onclick="copyDraft()">Copy</button>
          </div>

          <div class="hint" style="margin-top:14px;">
            <strong>Note:</strong> Review the draft carefully before sending. AI-generated content may need editing.
          </div>
        </div>

        <div id="draftEmpty" class="empty-state">
          <div class="empty-icon">‚ú¶</div>
          <div class="empty-text">Select emails from the inbox,<br/>then click "Draft with AI ‚Üí"</div>
        </div>

      </div>
    </div>

  </main>
  </div><!-- end emailView -->

  <!-- ‚îÄ‚îÄ‚îÄ Operator Blast View ‚îÄ‚îÄ‚îÄ -->
  <div id="blastView">

    <!-- Pane A: Trip Details -->
    <div class="pane">
      <div class="pane-header"><div class="pane-title">‚úà Trip Details</div></div>
      <div class="pane-body">
        <div class="setup-section">
          <label class="setup-label">Departure Airport</label>
          <input type="text" id="blastFrom" placeholder="e.g. SDL, PHX, DAL" />
        </div>
        <div class="setup-section">
          <label class="setup-label">Arrival Airport</label>
          <input type="text" id="blastTo" placeholder="e.g. LAX, VNY, BUR" />
        </div>
        <div class="setup-section">
          <label class="setup-label">Date</label>
          <input type="text" id="blastDate" placeholder="e.g. March 15, 2026" />
        </div>
        <div class="setup-section">
          <label class="setup-label">Passengers</label>
          <input type="number" id="blastPax" placeholder="e.g. 4" min="1" max="20" />
        </div>
        <div class="setup-section">
          <label class="setup-label">Aircraft Category Needed (select all that apply)</label>
          <div style="display:flex;flex-direction:column;gap:6px;margin-top:4px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text);">
              <input type="checkbox" class="aircraft-cat-cb" value="Very Light Jet" style="width:auto;accent-color:var(--warn);"> Very Light Jet</label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text);">
              <input type="checkbox" class="aircraft-cat-cb" value="Light Jet" style="width:auto;accent-color:var(--warn);"> Light Jet</label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text);">
              <input type="checkbox" class="aircraft-cat-cb" value="Midsize Jet" style="width:auto;accent-color:var(--warn);"> Midsize Jet</label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text);">
              <input type="checkbox" class="aircraft-cat-cb" value="Super-Midsize Jet" style="width:auto;accent-color:var(--warn);"> Super-Midsize Jet</label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text);">
              <input type="checkbox" class="aircraft-cat-cb" value="Large Cabin Jet" style="width:auto;accent-color:var(--warn);"> Large Cabin Jet</label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text);">
              <input type="checkbox" class="aircraft-cat-cb" value="Turboprop" style="width:auto;accent-color:var(--warn);"> Turboprop</label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text);">
              <input type="checkbox" class="aircraft-cat-cb" value="Open to all categories" style="width:auto;accent-color:var(--warn);"> Open / Any Category</label>
          </div>
        </div>
        <div class="setup-section">
          <label class="setup-label">One-Way or Round Trip</label>
          <select id="blastTripType">
            <option value="one-way">One-Way</option>
            <option value="round-trip">Round-Trip</option>
          </select>
        </div>
        <div class="setup-section">
          <label class="setup-label">Additional Notes (optional)</label>
          <textarea id="blastNotes" placeholder="e.g. Pets on board, specific aircraft preference, catering needs..." rows="3"></textarea>
        </div>
        <hr class="divider" />
        <div class="setup-section">
          <label class="setup-label">Search All Operators</label>
          <div class="filter-row">
            <input type="text" id="opSearchInput" placeholder="Search by name..." oninput="filterOperators()" />
          </div>
          <div style="font-size:10px;color:var(--muted);margin-bottom:8px;" id="opSearchCount"></div>
          <button class="btn btn-secondary btn-full btn-sm" onclick="selectAllVisible()">Select All Visible</button>
        </div>
      </div>
    </div>

    <!-- Pane B: Screenshot + Operator List -->
    <div class="pane">
      <div class="pane-header">
        <div class="pane-title">üìã Operators</div>
        <div style="font-size:11px;color:var(--muted);" id="opListCount"></div>
      </div>
      <div class="pane-body" id="opListPane">

        <!-- Screenshot upload -->
        <div class="drop-zone" id="screenshotZone" onclick="document.getElementById('screenshotInput').click()"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleScreenshotDrop(event)">
          <div class="drop-zone-icon">üì∏</div>
          <div class="drop-zone-text">
            <strong>Upload a screenshot</strong> from your operator database<br/>
            Claude will extract the operator names and match them to your master list
          </div>
          <img id="screenshotPreview" style="display:none;" />
        </div>
        <input type="file" id="screenshotInput" accept="image/*" style="display:none;" onchange="handleScreenshotFile(event)" />

        <div id="extractThinking" style="display:none;" class="ai-thinking">
          <div class="thinking-dots"><span></span><span></span><span></span></div>
          <span style="font-size:11px;color:var(--accent);">Claude is reading the screenshot...</span>
        </div>

        <!-- Operator list renders here -->
        <div id="opList">
          <div class="empty-state">
            <div class="empty-icon">‚úà</div>
            <div class="empty-text">Upload a screenshot or search operators<br/>on the left to build your BCC list</div>
          </div>
        </div>

      </div>
      <div class="blast-sel-bar" id="blastSelBar" style="display:none;">
        <div style="font-size:11px;color:var(--warn);" id="blastSelCount">0 operators selected</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-sm btn-secondary" onclick="clearBlastSelection()">Clear</button>
          <button class="btn btn-sm" style="background:var(--warn);color:#000;" onclick="buildBlastDraft()">Draft Outreach ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Pane C: Draft Email -->
    <div class="pane">
      <div class="pane-header"><div class="pane-title">üì® Outreach Draft</div></div>
      <div class="pane-body">

        <div id="blastThinking" style="display:none !important;" class="ai-thinking">
          <div class="thinking-dots"><span></span><span></span><span></span></div>
          <span style="font-size:11px;color:var(--accent);">Drafting your outreach email...</span>
        </div>

        <div id="blastDraftOutput" style="display:none;">
          <div class="draft-field">
            <label>BCC (all selected operators)</label>
            <div class="bcc-box" id="blastBccBox"></div>
            <div style="font-size:10px;color:var(--muted);margin-top:4px;" id="blastBccCount"></div>
          </div>
          <div class="draft-field">
            <label>Subject</label>
            <input type="text" id="blastSubject" />
          </div>
          <div class="draft-field">
            <label>Body</label>
            <textarea id="blastBody" rows="14"></textarea>
          </div>
          <div class="send-row">
            <button class="btn btn-full" style="background:var(--warn);color:#000;" onclick="sendBlast()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
              Send to All Operators
            </button>
            <button class="btn btn-secondary btn-sm" onclick="copyBlastDraft()">Copy</button>
          </div>
          <div class="hint" style="margin-top:14px;">
            <strong>Note:</strong> This sends as BCC so operators don't see each other's emails.
          </div>
        </div>

        <div id="blastDraftEmpty" class="empty-state">
          <div class="empty-icon">‚úà</div>
          <div class="empty-text">Select operators then click<br/>"Draft Outreach ‚Üí"</div>
        </div>

      </div>
    </div>

  </div><!-- end blastView -->

</div><!-- end app -->

<!-- Toast -->
<div id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Auth ‚Äî plain OAuth2 popup (no MSAL needed)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let accessToken = null;
let tokenExpiry = null;
let emails = [];
let selectedEmails = new Set();
let connectedEmail = '';

function getClientId() { return document.getElementById('clientId').value.trim(); }

// PKCE helpers
async function generatePKCE() {
  const verifier = base64url(crypto.getRandomValues(new Uint8Array(32)));
  const challenge = base64url(new Uint8Array(await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier))));
  return { verifier, challenge };
}
function base64url(buffer) {
  return btoa(String.fromCharCode(...buffer)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

async function connectOutlook() {
  const clientId = getClientId();
  if (!clientId) { showToast('Please enter your Azure Client ID first.', 'error'); return; }

  const redirectUri = 'https://gmozingo-bit.github.io/mailmind/callback.html';
  const scopes = 'openid profile email Mail.Read Mail.Send User.Read';
  const state = base64url(crypto.getRandomValues(new Uint8Array(16)));
  const { verifier, challenge } = await generatePKCE();

  // Store verifier so callback can use it
  sessionStorage.setItem('pkce_verifier', verifier);
  sessionStorage.setItem('pkce_state', state);

  const authUrl = `https://login.microsoftonline.com/26ca60d2-eab2-4238-a2f2-99ab35f6b796/oauth2/v2.0/authorize?` +
    `client_id=${clientId}` +
    `&response_type=code` +
    `&redirect_uri=${encodeURIComponent(redirectUri)}` +
    `&scope=${encodeURIComponent(scopes)}` +
    `&state=${state}` +
    `&code_challenge=${challenge}` +
    `&code_challenge_method=S256` +
    `&response_mode=query`;

  const popup = window.open(authUrl, 'mslogin', 'width=520,height=640,left=200,top=100');
  if (!popup) { showToast('Popup blocked! Please allow popups for this site in Chrome.', 'error'); return; }

  // Listen for auth code from callback.html via postMessage
  const handler = async (event) => {
    if (event.origin !== 'https://gmozingo-bit.github.io') return;
    window.removeEventListener('message', handler);

    if (event.data.type === 'ms_auth_code') {
      const code = event.data.code;
      const savedVerifier = sessionStorage.getItem('pkce_verifier');
      // Exchange code for token
      try {
        const tokenRes = await fetch(`https://login.microsoftonline.com/26ca60d2-eab2-4238-a2f2-99ab35f6b796/oauth2/v2.0/token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            client_id: clientId,
            grant_type: 'authorization_code',
            code,
            redirect_uri: redirectUri,
            code_verifier: savedVerifier,
            scope: scopes
          })
        });
        const tokenData = await tokenRes.json();
        if (tokenData.access_token) {
          accessToken = tokenData.access_token;
          tokenExpiry = Date.now() + (tokenData.expires_in || 3600) * 1000;
          sessionStorage.setItem('refresh_token', tokenData.refresh_token || '');
          const meRes = await fetch('https://graph.microsoft.com/v1.0/me', {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          const u = await meRes.json();
          setOutlookConnected(u.mail || u.userPrincipalName || 'Connected');
          showToast('Connected to Outlook!', 'success');
        } else {
          showToast('Token error: ' + (tokenData.error_description || tokenData.error), 'error');
        }
      } catch(e) {
        showToast('Auth failed: ' + e.message, 'error');
      }
    } else if (event.data.type === 'ms_auth_error') {
      showToast('Login failed: ' + event.data.error, 'error');
    }
  };
  window.addEventListener('message', handler);

  const check = setInterval(() => {
    if (popup.closed) { clearInterval(check); window.removeEventListener('message', handler); }
  }, 1000);
}

async function refreshToken() {
  if (accessToken && tokenExpiry && Date.now() < tokenExpiry - 60000) return;
  const refreshTok = sessionStorage.getItem('refresh_token');
  if (!refreshTok) { await connectOutlook(); return; }
  try {
    const res = await fetch(`https://login.microsoftonline.com/26ca60d2-eab2-4238-a2f2-99ab35f6b796/oauth2/v2.0/token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        client_id: getClientId(),
        grant_type: 'refresh_token',
        refresh_token: refreshTok,
        scope: 'Mail.Read Mail.Send User.Read'
      })
    });
    const data = await res.json();
    if (data.access_token) {
      accessToken = data.access_token;
      tokenExpiry = Date.now() + (data.expires_in || 3600) * 1000;
      if (data.refresh_token) sessionStorage.setItem('refresh_token', data.refresh_token);
    } else {
      await connectOutlook();
    }
  } catch(e) { await connectOutlook(); }
}

function signOut() {
  accessToken = null; tokenExpiry = null; emails = []; selectedEmails.clear();
  sessionStorage.removeItem('refresh_token');
  const s = document.getElementById('outlookStatus');
  s.className = 'status-pill';
  s.innerHTML = '<span class="dot"></span>Outlook disconnected';
  document.getElementById('connectBtn').style.display = 'block';
  document.getElementById('signOutBtn').style.display = 'none';
  document.getElementById('fetchBtn').disabled = true;
  document.getElementById('emailList').innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-text">Connect your Outlook account<br/>and fetch emails to get started</div></div>`;
  document.getElementById('emailCount').textContent = '';
  document.getElementById('selBar').style.display = 'none';
}

function setOutlookConnected(email) {
  connectedEmail = email || '';
  const s = document.getElementById('outlookStatus');
  s.className = 'status-pill connected';
  s.innerHTML = `<span class="dot"></span>${email || 'Connected'}`;
  document.getElementById('connectBtn').style.display = 'none';
  document.getElementById('signOutBtn').style.display = 'block';
  document.getElementById('fetchBtn').disabled = false;
}

async function fetchEmails() {
  if (!accessToken) { showToast('Please connect first.', 'error'); return; }
  const btn = document.getElementById('fetchBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Fetching...';
  try {
    await refreshToken();
    const count = document.getElementById('fetchCount').value;
    const keyword = document.getElementById('filterKeyword').value.trim();
    let url = `https://graph.microsoft.com/v1.0/me/messages?$top=${count}&$select=id,subject,from,bodyPreview,receivedDateTime,body&$orderby=receivedDateTime desc`;
    if (keyword) url += `&$search="${encodeURIComponent(keyword)}"`;

    const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    emails = data.value || [];
    renderEmails();
    showToast(`Fetched ${emails.length} emails`, 'success');
  } catch (e) {
    console.error(e);
    showToast('Failed to fetch emails: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Fetch Emails';
  }
}

function renderEmails() {
  const list = document.getElementById('emailList');
  document.getElementById('emailCount').textContent = `${emails.length} emails`;
  if (!emails.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-text">No emails found</div></div>`;
    return;
  }
  list.innerHTML = emails.map((e, i) => {
    const from = e.from?.emailAddress?.name || e.from?.emailAddress?.address || 'Unknown';
    const date = new Date(e.receivedDateTime).toLocaleDateString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    return `<div class="email-item" id="email-${i}" onclick="toggleEmail(${i})">
      <div class="email-from">${escHtml(from)}</div>
      <div class="email-subject">${escHtml(e.subject || '(no subject)')}</div>
      <div class="email-preview">${escHtml(e.bodyPreview || '')}</div>
      <div class="email-meta">
        <span class="email-date">${date}</span>
      </div>
    </div>`;
  }).join('');
}

function toggleEmail(i) {
  if (selectedEmails.has(i)) selectedEmails.delete(i);
  else selectedEmails.add(i);
  document.getElementById(`email-${i}`).classList.toggle('selected', selectedEmails.has(i));
  updateSelBar();
}

function updateSelBar() {
  const bar = document.getElementById('selBar');
  if (selectedEmails.size > 0) {
    bar.style.display = 'flex';
    document.getElementById('selCount').textContent = `${selectedEmails.size} email${selectedEmails.size > 1 ? 's' : ''} selected`;
  } else {
    bar.style.display = 'none';
  }
}

function clearSelection() {
  selectedEmails.forEach(i => document.getElementById(`email-${i}`)?.classList.remove('selected'));
  selectedEmails.clear();
  updateSelBar();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Template chips
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const templates = {
  summarize: "Read these emails and draft a professional reply that summarizes the key points, acknowledges any requests, and provides a concise response.",
  forward: "Read these emails and draft a forwarding email to my manager summarizing the key information, open questions, and any action items.",
  actionitems: "Read these emails and draft a clean action-items recap email listing who needs to do what and by when, formatted clearly.",
  report: "Read these emails and draft a status update email summarizing project or topic progress, blockers, and next steps.",
  clientquote: `You are an assistant for a private-jet charter broker. Read the email(s) to extract the client name, trip details (departure/arrival airports, date, one-way or round-trip), and any aircraft options with base prices provided.

BACKEND CALCULATION (perform this first, show all steps clearly before generating the email):
For each aircraft option:
1. Start with the base subtotal
2. Add 7.5% Federal Excise Tax (FET) on the base subtotal
3. Add $30 segment fee (unless otherwise specified)
4. Apply 10% markup on the new total (after FET and segment fee)
5. This gives the FULL total
6. CLIENT-FACING price = FULL total minus the 7.5% FET amount (FET is hidden from client)
Round only at the final step using standard rounding rules to two decimal places.

EMAIL FORMAT (after backend calc, generate this clean client-facing email):

Subject: Your Charter Options ‚Äì [Departure] to [Arrival] | [Date]

Hi [Client Name],

Below are your charter options for the [one-way/round-trip] flight between [Departure Airport] and [Arrival Airport] on [Date]:

[Category Name ‚Äî e.g. Light Jet]
[Aircraft Name] ‚Äì $[xx,xxx.xx]

[Category Name ‚Äî e.g. Very Light Jets]
[Aircraft Name] ‚Äì $[xx,xxx.xx]

[Repeat for all categories in this exact order: 1. Light Jet, 2. Very Light Jets, 3. Super-Midsize Jet, 4. Midsize Jet, 5. Large Cabin ‚Äî only include categories that apply]

üèÜ Why Fly with Valley Jet?

‚úî Unmatched Access ‚Äì Choose from 9,000+ vetted aircraft across all categories: light, midsize, super-midsize, and large cabin jets.
End-to-End Luxury ‚Äì Helicopter transfers, gourmet catering, and chauffeured ground transport‚Äîall seamlessly arranged.
Trusted by Clients Nationwide ‚Äì Our loyal flyers return time and again for our transparency, service, and reliability.

üì£ See what they're saying ‚Üí bit.ly/GoogleReviewVJ

Let me know if you'd like to move forward with any of these options or if you have any questions.

Best regards,
Valley Jet

IMPORTANT RULES:
- Do not list or mention any tax, fee, or commission anywhere in the client email
- Never use the word "commission"
- Do not include operator names or tail numbers
- Do not use emoji in category headers
- Keep formatting clean and suitable for pasting into Apple Mail or email client
- If any aircraft is quoted from a different airport than the primary departure airport, add a note next to that aircraft (e.g., "PHX instead of SDL") and a brief note below explaining the airport alternative reduces cost if the client is flexible
- Show only final client-facing prices (FET removed from display, but calculated in backend)
- The ‚úî emoji appears only once, exactly before "Unmatched Access"
- $30 segment fee applies unless otherwise specified`
};

function setTemplate(key) {
  document.querySelectorAll('.prompt-chip').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('aiInstruction').value = templates[key];
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AI Draft
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function analyzeAndDraft() {
  const apiKey = document.getElementById('anthropicKey').value.trim();
  if (!apiKey) { showToast('Please enter your Anthropic API key.', 'error'); return; }
  if (selectedEmails.size === 0) { showToast('Select at least one email.', 'error'); return; }
  const instruction = document.getElementById('aiInstruction').value.trim() || templates.summarize;

  // Build email content
  const emailContent = [...selectedEmails].map(i => {
    const e = emails[i];
    const from = e.from?.emailAddress?.address || '';
    const body = e.body?.content || e.bodyPreview || '';
    const cleanBody = body.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').slice(0, 2000);
    return `--- EMAIL ${i+1} ---\nFrom: ${from}\nSubject: ${e.subject}\nDate: ${e.receivedDateTime}\nBody: ${cleanBody}`;
  }).join('\n\n');

  // Show UI
  document.getElementById('thinkingIndicator').style.display = 'flex';
  document.getElementById('draftOutput').style.display = 'none';
  document.getElementById('draftEmpty').style.display = 'none';
  document.getElementById('draftBtn').disabled = true;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4096,
        system: `You are an expert email assistant. The user will give you email content and an instruction. 
You MUST respond with ONLY a valid JSON object in this exact format, no other text:
{
  "to": "suggested recipient email if determinable, else empty string",
  "subject": "email subject line",
  "body": "ONLY the final client-facing email body, plain text, no HTML. For quote emails, this is ONLY the clean client email ‚Äî no calculations here.",
  "calculations": "For quote/pricing emails: show the full step-by-step backend calculation for every aircraft here. For all other email types, leave this as an empty string."
}`,
        messages: [{
          role: 'user',
          content: `Instruction: ${instruction}\n\n${emailContent}`
        }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API error');
    }

    const data = await response.json();
    let text = data.content?.[0]?.text || '';
    // Strip markdown fences
    text = text.replace(/```json|```/g, '').trim();
    const draft = JSON.parse(text);

    document.getElementById('draftTo').value = draft.to || '';
    document.getElementById('draftSubject').value = draft.subject || '';
    document.getElementById('draftBody').value = draft.body || '';

    // Show backend calculations if present (quote mode)
    const calcPanel = document.getElementById('calcPanel');
    if (draft.calculations && draft.calculations.trim()) {
      document.getElementById('calcBody').value = draft.calculations;
      calcPanel.style.display = 'block';
    } else {
      calcPanel.style.display = 'none';
    }

    document.getElementById('draftOutput').style.display = 'block';
    showToast('Draft ready!', 'success');
  } catch (e) {
    console.error(e);
    showToast('AI error: ' + e.message, 'error');
    document.getElementById('draftEmpty').style.display = 'flex';
  } finally {
    document.getElementById('thinkingIndicator').style.display = 'none';
    document.getElementById('draftBtn').disabled = false;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Send email
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendEmail() {
  if (!accessToken) { showToast('Not connected to Outlook.', 'error'); return; }
  const to = document.getElementById('draftTo').value.trim();
  const subject = document.getElementById('draftSubject').value.trim();
  const body = document.getElementById('draftBody').value.trim();
  if (!to) { showToast('Please enter a recipient email address.', 'error'); return; }

  const sendBtn = document.querySelector('.btn-success');
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<span class="spinner"></span> Sending...';

  try {
    await refreshToken();
    const message = {
      message: {
        subject,
        body: { contentType: 'Text', content: body },
        toRecipients: to.split(',').map(a => ({ emailAddress: { address: a.trim() } }))
      }
    };
    const res = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(message)
    });
    if (!res.ok) throw new Error(await res.text());
    showToast('Email sent successfully!', 'success');
    sendBtn.innerHTML = '‚úì Sent!';
    setTimeout(() => {
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg> Send via Outlook';
    }, 3000);
  } catch (e) {
    console.error(e);
    showToast('Send failed: ' + e.message, 'error');
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg> Send via Outlook';
  }
}

function copyDraft() {
  const body = document.getElementById('draftBody').value;
  const subject = document.getElementById('draftSubject').value;
  navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`).then(() => {
    showToast('Copied to clipboard!', 'success');
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Utils
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer;
function showToast(msg, type='') {
  clearTimeout(toastTimer);
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show ' + type;
  toastTimer = setTimeout(() => { t.className = ''; }, 3500);
}

// Pre-fill redirect URI
window.addEventListener('load', () => {
  document.getElementById('redirectUri').value = window.location.href.split('?')[0];
  renderAllOperators();
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Tab Switching
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.getElementById('emailView').style.display = tab === 'email' ? 'grid' : 'none';
  document.getElementById('blastView').style.display = tab === 'blast' ? 'grid' : 'none';
  document.getElementById('tabEmail').classList.toggle('active', tab === 'email');
  document.getElementById('tabBlast').classList.toggle('active', tab === 'blast');
  if (tab === 'blast') renderAllOperators();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Operator Master List (454 operators)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MASTER_OPERATORS = [{"name":"24/7 JET, INC.","email":"sales@247jet.com"},{"name":"ABILENE AERO","email":"charter@abileneaero.com"},{"name":"ADVANCED AIR LLC","email":"flights@advancedairlines.com"},{"name":"AERO AIR CHARTER LLC","email":"hi@flywithaero.com"},{"name":"AERO AIR LLC","email":"flightops@aeroair.com"},{"name":"AIR ASSOCIATES CHARTER","email":"charter@airassociatesinc.com"},{"name":"AIR CHARTERS INC","email":"charter@airchartersteb.com"},{"name":"AIR7","email":"charter@flyair7.com"},{"name":"AIRCRAFT SERVICES GROUP","email":"charter@jetasg.com"},{"name":"AIRCRAFT TRANSPORT SERVICE","email":"charter@atsflights.com"},{"name":"AIRFLAIR INC","email":"info@airflairinc.com"},{"name":"AIRRESOURCE CHARTER LLC","email":"carl@airresourcegroup.com"},{"name":"AIRSHARE","email":"charter@flyairshare.com"},{"name":"AIRSHARE (OPERATED BY CIRCADIAN AVIATION LLC)","email":"quotes@flyairshare.com"},{"name":"AIRSMART","email":"sales@airsmartshare.com"},{"name":"AKAMAI AIR, LLC","email":"akamaiaircharter@gmail.com"},{"name":"AKLAK AIR LIMITED","email":"CHARTERS@AKLAKAIR.CA"},{"name":"ALERION AVIATION","email":"charter@flyalerion.com"},{"name":"ALGJET","email":"chris@algjet.com"},{"name":"ALPHA JET CHARTER","email":"chartersales@alphajet.com"},{"name":"ALTIUS AVIATION LLC","email":"info@flyaltius.com"},{"name":"AMERICAN JET INTERNATIONAL CORPORATION","email":"chartersales@iflyaji.com"},{"name":"AMERISTAR JET CHARTER, INC","email":"QUOTES@AMERISTARJET.COM"},{"name":"AMERITEX AIRWAYS INC","email":"sales@ameritexjet.com"},{"name":"ATS","email":"charter@atsflights.com"},{"name":"ATS AIR CHARTER","email":"charter@aerotechservices.com"},{"name":"AVALAIR AIRCRAFT MANAGEMENT LLC","email":"charter@avalair.com"},{"name":"AVCENTER INC","email":"charter@avcenter.com"},{"name":"AVIATION CHARTERS","email":"charter@aviationcharters.com"},{"name":"AVIATION SERVICES ELITE","email":"charter@myelitejet.com"},{"name":"AVION JET CHARTER","email":"info@avionjetcharter.net"},{"name":"AYLA AVIATION","email":"id@ayla.aero"},{"name":"BAKER AVIATION LLC","email":"charter@baker-aviation.com"},{"name":"BELLAIR AVIATION LLC","email":"charter@flybellair.com"},{"name":"BRAZOS VALLEY AIR CHARTER LLC","email":"achenoweth@brazosvalleyair.com"},{"name":"BUN AIR CHARTER","email":"charter@bunaircorp.com"},{"name":"CAPITAL JET CHARTER","email":"glenn@capitaljetcharter.com"},{"name":"CENTRAL FLYING SERVICE INC","email":"charter@central.aero"},{"name":"CENTURY AVIATION INC","email":"operations@centuryaviation.us"},{"name":"CENTURY JETS","email":"charter@centuryjets.com"},{"name":"CHAIRMAN AVIATION LLC","email":"Bryan@ChairmanAviation.com"},{"name":"CHARTER AIRLINES","email":"chartersales@flycharterairlines.net"},{"name":"CHARTER ONE INC","email":"charter@charter1.com"},{"name":"CHICAGO JET GROUP","email":"charter@cjg.aero"},{"name":"CHOICE AVIATION LLC","email":"flight@choiceaviation.com"},{"name":"CHRYSLER AVIATION INC","email":"info@chrysleraviation.com"},{"name":"CIRRUS AVIATION SERVICES","email":"sales@cirrusav.com"},{"name":"CLAY LACY AVIATION","email":"charter@claylacy.com"},{"name":"CLUB JET CHARTER","email":"request@clubjet.net"},{"name":"CONTOUR AVIATION","email":"charter@flycontour.com"},{"name":"CRAFT CHARTER","email":"charter@craftcharter.com"},{"name":"CUTTER AVIATION","email":"charter@cutteraviation.com"},{"name":"DESERT JET LLC","email":"flights@flyadvancedair.com"},{"name":"DIAMOND AVIATION","email":"charter@diamondaviation.biz"},{"name":"DISCOVERY JETS","email":"charter.sales@discoveryjets.com"},{"name":"DREAMLINE AVIATION LLC","email":"charter@dljets.com"},{"name":"EAGLE AIR AVIATION","email":"charter@eagleairaviation.com"},{"name":"EAST COAST FLIGHT SERVICES INC","email":"charter@eastcoastjets.com"},{"name":"ELEVAGE FLIGHT TRAVEL","email":"info@elevage.travel"},{"name":"ELIT'AVIA AMERICAS","email":"charter@elitavia.com"},{"name":"ELITE AIR INC","email":"charter@eliteair.com"},{"name":"ENCORE JET MANAGEMENT LLC","email":"charters@encorejet.us"},{"name":"ERIN AIR INC","email":"charter@erinair.com"},{"name":"ETC JETS","email":"brent@easttexascharter.com"},{"name":"EXEC 1 AVIATION","email":"charter@exec1aviation.com"},{"name":"EXEC AIR MONTANA INC","email":"office@execairmontana.com"},{"name":"EXECUTIVE FLITEWAYS","email":"charter@fly-efi.com"},{"name":"EXECUTIVE JET MANAGEMENT","email":"quotes@ejmjets.com"},{"name":"FIRST AV GROUP LLC","email":"steve@firstavgroup.com"},{"name":"FLIGHT CONCEPTS INC","email":"charter@fltconcepts.com"},{"name":"FLYADVANCED","email":"charter@flyadvanced.com"},{"name":"FLYCAROLINA LLC","email":"charter@flycarolina.com"},{"name":"FLYEXCLUSIVE","email":"sales@flyexclusive.com"},{"name":"FLYHOUSE","email":"charter@flyhouse.us"},{"name":"FLYTRU","email":"quotes@flytru.com"},{"name":"FOUNDATION AVIATION","email":"sales@foundationaviation.com"},{"name":"GLOBAL AIR CHARTERS","email":"gacsales@gac.aero"},{"name":"GLOBAL AVIATION INC","email":"charter@flyglobalnow.com"},{"name":"GOLD AVIATION","email":"charter@goldaviation.com"},{"name":"GOLDEN STATE AIR CHARTER LLC","email":"charter@goldenstateair.com"},{"name":"HANGAR 7 AVIATION","email":"charter@flyhangar7.com"},{"name":"HAVEN AERO","email":"info@havenaero.com"},{"name":"INTERNATIONAL GROUP LLC","email":"charter@fly-ig.com"},{"name":"JET 1 CHARTER","email":"charter@flyjet1.com"},{"name":"JET ACCESS AVIATION","email":"sales@flyja.com"},{"name":"JET AIR INC","email":"charter@jetairinc.com"},{"name":"JET AVIATION","email":"charter.usa@jetaviation.com"},{"name":"JET LINX AVIATION","email":"charter@jetlinx.com"},{"name":"JET METHODS INC","email":"charter@jetmethods.com"},{"name":"JET SERVICES INC","email":"scheduling@flyjetservices.com"},{"name":"JET THERE LLC","email":"charter@flyjetthere.com"},{"name":"JET UP AVIATION LLC","email":"dan@jetupaviation.com"},{"name":"JET-A LLC","email":"fly@jet-a.com"},{"name":"JETNEXA","email":"charter@jetnexa.com"},{"name":"JETVIA (FORMERLY ATI JET)","email":"info@jetvia.com"},{"name":"JOHNSON AVIATION","email":"johnson.aviation@gmail.com"},{"name":"JSX","email":"charter@jsx.com"},{"name":"JUSTICE AIR CHARTER","email":"charter@justiceair.com"},{"name":"KCAC AVIATION","email":"charter@kcac.com"},{"name":"LATITUDE 33 AVIATION","email":"charter@l33jets.com"},{"name":"LEGACY JETS","email":"charter@legacyjets.com"},{"name":"LET'S JETT","email":"sales@letsjett.com"},{"name":"LEVIATE AIR GROUP","email":"charter@leviateair.com"},{"name":"LIBERTY JET","email":"charter@libertyjet.com"},{"name":"LONE STAR AVIATORS","email":"info@lonestaraviators.com"},{"name":"LOYD'S AVIATION","email":"charter@loydsaviation.com"},{"name":"LYON AVIATION INC","email":"charter@lyonaviation.com"},{"name":"M&N AVIATION","email":"charter@mandn.aero"},{"name":"MAC JET CHARTER","email":"charter@macairgroup.com"},{"name":"MACH ONE AIR CHARTERS INC","email":"charter@moaci.com"},{"name":"MIDWEST FLYING SERVICE","email":"info@midwestflyingservice.com"},{"name":"MOUNTAIN LION AVIATION","email":"jt@phhllc.com"},{"name":"NEW WORLD AVIATION","email":"charter@newworldaviation.com"},{"name":"NEXJET CORPORATION","email":"info@nexjet.com"},{"name":"NICHOLAS AIR","email":"charter@nicholasair.com"},{"name":"NORTH AMERICAN AIR CHARTER INC","email":"charter@naac.com"},{"name":"NORTH DALLAS AVIATION","email":"charter@flynda.com"},{"name":"NORTHEASTERN AVIATION CORP","email":"charter@neajets.com"},{"name":"NOW AIR LLC","email":"chartersales@nowairllc.com"},{"name":"ONWARD JETS, LLC","email":"sales@onwardjets.com"},{"name":"PARADIGM JET MANAGEMENT","email":"charter@paradigmjet.com"},{"name":"PARADISE JETS LLC","email":"sales@paradisejets.com"},{"name":"PARAGON AIRWAYS","email":"charter@paragonairways.com"},{"name":"PEGASUS ELITE AVIATION INC","email":"sales@pegjet.com"},{"name":"PEREGRINE AIR CHARTERS LLC","email":"info@peregrineaircharter.com"},{"name":"PINNACLE AVIATION","email":"charter@pinnacleaviation.com"},{"name":"PLANET 9","email":"sales@flyplanet9.com"},{"name":"PORTLAND JETS","email":"charter@portjets.com"},{"name":"PREMIER AIR CHARTER LLC","email":"charter@premieraircharter.com"},{"name":"PREMIER JETS INC","email":"operations@premierjets.com"},{"name":"PRESIDENTIAL AVIATION INC","email":"charter@presidential-aviation.com"},{"name":"PRESTIGE AIR GROUP LLC","email":"bookings@prestigeairgroup.com"},{"name":"PRIESTER AVIATION LLC","email":"quotes@priesterav.com"},{"name":"PRIME JET","email":"charter@primejet.com"},{"name":"PRISMJET","email":"charter@prismjet.net"},{"name":"PRIVATE JETS INC","email":"pjets.szepeda@gmail.com"},{"name":"PVT AIR","email":"admin@pvtair.com"},{"name":"REGENCY AIR LLC","email":"charter@regencyair.com"},{"name":"RELIANT AIR CHARTER INC","email":"contact@reliantair.com"},{"name":"RENNIA GLOBAL","email":"charter@renniaglobal.com"},{"name":"ROCKHILL AVIATION INC","email":"sales@rockhillaviation.com"},{"name":"RVR AIR CHARTER","email":"charter@rvrair.com"},{"name":"SCHUBACH AVIATION","email":"sales@schubachaviation.com"},{"name":"SENECA FLIGHT OPERATIONS","email":"info@senecaflight.com"},{"name":"SHORT HILLS AVIATION SERVICES","email":"charter@shorthillsaviation.com"},{"name":"SILVER AIR","email":"charter@silverair.com"},{"name":"SILVERHAWK AVIATION","email":"charter@silverhawkaviation.com"},{"name":"SKYDANCE AIR","email":"chartersales@skydanceair.com"},{"name":"SKYNET AIR CHARTER","email":"charter@skynetcharter.com"},{"name":"SKYSTREAM JET","email":"charter@skystreamjet.com"},{"name":"SOFAR AIR","email":"hq@flysofar.com"},{"name":"SOLAIRUS AVIATION","email":"charter@solairus.aero"},{"name":"SOULBIRD AVIATION LLC","email":"charter@flysoulbird.com"},{"name":"SOUTHERN SKY AVIATION LLC","email":"charter@southernskyaviation.com"},{"name":"SPEED AVIATION INC","email":"steve.hauth@speedaviationinc.com"},{"name":"STA JETS","email":"charter@stajets.com"},{"name":"STARFLITE AVIATION","email":"charter@starfliteaviation.com"},{"name":"STARJET INC","email":"charter@starjetinc.com"},{"name":"STEBBINS AVIATION INC","email":"charter@stebbinsav.com"},{"name":"SUNBIRD AVIATION LLC","email":"charter@ocsunbird.com"},{"name":"SUNRISE JETS","email":"charter@sunrisejets.com"},{"name":"SUPERIOR AIR CHARTER LLC","email":"charter@superior.flights"},{"name":"SWC SKYWEST CHARTER","email":"trenton.moss@flyswc.com"},{"name":"TAG GLOBAL","email":"info@flytti.com"},{"name":"TALON AIR INC","email":"ca@talonairjets.com"},{"name":"TAUGHANNOCK AVIATION CORP","email":"flight@flytac.com"},{"name":"TAVAERO JET CHARTER CORPORATION","email":"charter@tavaero.com"},{"name":"THADEN FIELD","email":"charter@thadenfield.com"},{"name":"THRIVE AVIATION","email":"charter@flythrive.com"},{"name":"TITAN AVIATION (OPB ONYX AIR)","email":"info@tajets.aero"},{"name":"TODDCOE AVIATION","email":"charter@toddcoeaviation.com"},{"name":"TRADEWIND AVIATION LLC","email":"charter@flytradewind.com"},{"name":"TRANS-EXEC PRIVATE JETS","email":"charter@transexec.com"},{"name":"TRIDENT AIRCRAFT, INC","email":"charter@tridentaircraft.com"},{"name":"TRITON AIR","email":"tripmanagement@flytritonair.com"},{"name":"VENTURA AIR SERVICES INC","email":"charter@ventura.aero"},{"name":"VISTA US (OPB JET SELECT LLC)","email":"salesus@vistajet.com"},{"name":"VOLATO","email":"charters@flyvolato.com"},{"name":"WEST COAST AVIATION SERVICES","email":"charter@wcas.aero"},{"name":"WHEELS UP","email":"quotes@wheelsup.com"},{"name":"WING AVIATION CHARTER SERVICES LLC","email":"charter@wingaviation.com"},{"name":"WORLDWIDE JET","email":"charter@worldwidejet.com"},{"name":"X-PRESS CHARTER SERVICES INC","email":"REQUESTS@XPRESSCHARTER.COM"},{"name":"XCEL JET MANAGEMENT INC","email":"charter@xceljet.com"},{"name":"VIH EXECUJET LTD","email":"charter@vih.com"},{"name":"AURORA JET PARTNERS","email":"charters@aurorajet.ca"},{"name":"ANDERSON AIR LTD","email":"dispatch@andersonair.ca"},{"name":"SELECT AERO INC","email":"info@select.aero"},{"name":"AD ASTRA","email":"dom@adastraflights.com"},{"name":"ADVANCED AIR","email":"flights@flyadvancedair.com"},{"name":"AMERICAN JET CHARTER INC","email":"charter@american-jet.com"},{"name":"CLEMENS AVIATION LLC","email":"sales@clemensaviation.com"},{"name":"ENG AVIATION","email":"charter@engaviation.com"},{"name":"LYDDON AERO CENTER INC","email":"jen@lyddonaero.com"},{"name":"KERN CHARTER SERVICE INC","email":"INFO@KERNCHARTER.COM"},{"name":"OPTIMAL AVIATION SERVICES LLC","email":"flyoptimalaviation@gmail.com"},{"name":"ABOVE ALL AVIATION, INC.","email":"fly@aboveallsba.com"},{"name":"SUN AIR JETS, LLC","email":"charter@sunairjets.com"},{"name":"MARC AIR","email":"lloyd@marcair.com"},{"name":"CLIPPER AVIATION CHARTER","email":"charter@clipperaviation.com"},{"name":"WESTAIR CHARTER","email":"charter@westair.com"},{"name":"HARVEY AVIATION","email":"info@harveyaviation.com"},{"name":"CSM AVIATION","email":"charter@csmaviation.com"},{"name":"ACTION AIR EXPRESS INC","email":"INFO@ACTIONAIREXPRESS.COM"},{"name":"JET EXCELLENCE","email":"charter@jetexcellence.com"},{"name":"AERY AVIATION LLC","email":"aerydispatch@aeryaviation.com"},{"name":"AIRA AVIATION LLC","email":"info@airaaviation.com"},{"name":"AIRQUEST AVIATION LP","email":"charter@airquestaviation.com"},{"name":"AITHERAS AVIATION GROUP LLC","email":"marc@aagjet.com"},{"name":"AMG JETS","email":"charter@amgjets.com"},{"name":"BUSINESS JET MANAGERS INC","email":"dispatch@businessjetmanagers.com"},{"name":"CASTLE AVIATION INC","email":"fltops@castleair.com"},{"name":"CORPORATE AIR LLC","email":"charter@corporateairllc.com"},{"name":"FLAGSHIP PRIVATE AIR LLC","email":"charter@flagshipprivateair.com"},{"name":"GRIFFING FLYING SERVICE INC","email":"charter@flygriffing.com"},{"name":"JET AMERICA INC","email":"charter@jetamericainc.com"},{"name":"JETPORT INC","email":"charters@jetport.com"},{"name":"KALITTA CHARTERS LLC","email":"135ops@kalittacharters.com"},{"name":"NORTHSTAR BUSINESS AVIATION","email":"charter@northstarair.com"},{"name":"PENTASTAR AVIATION CHARTER","email":"charterquote@pentastar.aero"},{"name":"PRIVATE JET CENTER","email":"charter@flypjc.com"},{"name":"ROYAL AIR CHARTER","email":"charter@royalair.com"},{"name":"SKY QUEST LLC","email":"charter@flyskyquest.com"},{"name":"SWEET AVIATION","email":"charter@sweetaviation.com"},{"name":"FLIGHTEXEC","email":"travelsolutions@flightexec.com"},{"name":"JETVIA","email":"sales@jetvia.com"},{"name":"APEX JETS","email":"charter@apexjets.net"},{"name":"MAYO AVIATION INC","email":"quotes@mayoaviation.com"},{"name":"RB AVIATION LLC","email":"charters@rb-aviation.com"},{"name":"NEW ENGLAND AIR TRANSPORT INC","email":"hello@flyneatair.com"},{"name":"INTERNATIONAL JET AVIATION SERVICES INC","email":"ADAM@INTERNATIONALJET.COM"},{"name":"PRECISION AIRCRAFT MANAGEMENT","email":"scheduling@precisionacm.com"},{"name":"SOUTHWEST AIRCRAFT CHARTER","email":"info@swaircraftcharter.com"},{"name":"MODESTO JET CENTER","email":"fly@modestojet.com"},{"name":"SLATE AVIATION","email":"smunroe@flyslate.com"},{"name":"ZENFLIGHT","email":"fly@zenflight.com"},{"name":"SPRING CITY AVIATION","email":"charter@springcityaviation.com"},{"name":"45 NORTH AVIATION","email":"info@45northaviation.com"},{"name":"TRITON AIRWAYS LLC","email":"charter@tritonairways.com"},{"name":"CENTURION FLIGHT SERVICES INC","email":"charter@centurionfs.com"},{"name":"HIGHRIZE AVIATION LLC","email":"info@highrizeaviation.com"},{"name":"FUGA AIR CHARTER","email":"Ifly@airfuga.com"},{"name":"ASPEN HELICOPTERS INC","email":"dispatch@aspenhelo.com"},{"name":"FREEDOM AIR LLC","email":"sean.harris@freedomairllc.com"},{"name":"RFS AVIATION","email":"charles@rfsaviation.com"},{"name":"GOLD AERO","email":"goldaeroinc@gmail.com"},{"name":"FLIGHTLINE FIRST LLC","email":"flightlinefirst@gmail.com"},{"name":"MOUNTAIN AIR CHARTER LLC","email":"jt@phhllc.com"},{"name":"PLANESMART! CHARTER, LLC","email":"charter@planesmart.com"}];

// deduplicate by email
const seen = new Set();
const OPERATORS = MASTER_OPERATORS.filter(o => {
  const key = o.email.toLowerCase().trim();
  if (seen.has(key)) return false;
  seen.add(key); return true;
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Operator Blast State
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let blastSelected = new Set(); // indices into OPERATORS
let visibleOperators = [...OPERATORS.keys()]; // indices of visible operators

function renderAllOperators() {
  visibleOperators = OPERATORS.map((_, i) => i);
  document.getElementById('opSearchCount').textContent = `${OPERATORS.length} operators in master list`;
  renderOpList(visibleOperators);
}

function filterOperators() {
  const q = document.getElementById('opSearchInput').value.trim().toLowerCase();
  if (!q) { visibleOperators = OPERATORS.map((_, i) => i); }
  else { visibleOperators = OPERATORS.map((o, i) => q && (o.name.toLowerCase().includes(q) || o.email.toLowerCase().includes(q)) ? i : -1).filter(i => i >= 0); }
  document.getElementById('opSearchCount').textContent = `${visibleOperators.length} operators found`;
  renderOpList(visibleOperators);
}

function renderOpList(indices) {
  const el = document.getElementById('opList');
  document.getElementById('opListCount').textContent = `${indices.length} shown`;
  if (!indices.length) { el.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-text">No operators found</div></div>`; return; }
  el.innerHTML = indices.map(i => {
    const op = OPERATORS[i];
    const sel = blastSelected.has(i);
    return `<div class="op-item ${sel ? 'selected' : ''}" onclick="toggleOp(${i})">
      <div class="op-check">${sel ? '‚úì' : ''}</div>
      <div style="flex:1;min-width:0;">
        <div class="op-name">${escHtml(op.name)}</div>
        <div class="op-email">${escHtml(op.email)}</div>
      </div>
    </div>`;
  }).join('');
  updateBlastSelBar();
}

function toggleOp(i) {
  if (blastSelected.has(i)) blastSelected.delete(i);
  else blastSelected.add(i);
  // Re-render just that item
  const items = document.querySelectorAll('.op-item');
  const idx = visibleOperators.indexOf(i);
  if (idx >= 0 && items[idx]) {
    const sel = blastSelected.has(i);
    items[idx].className = `op-item ${sel ? 'selected' : ''}`;
    items[idx].querySelector('.op-check').textContent = sel ? '‚úì' : '';
  }
  updateBlastSelBar();
}

function selectAllVisible() {
  visibleOperators.forEach(i => blastSelected.add(i));
  renderOpList(visibleOperators);
}

function clearBlastSelection() {
  blastSelected.clear();
  renderOpList(visibleOperators);
}

function updateBlastSelBar() {
  const bar = document.getElementById('blastSelBar');
  if (blastSelected.size > 0) {
    bar.style.display = 'flex';
    document.getElementById('blastSelCount').textContent = `${blastSelected.size} operator${blastSelected.size > 1 ? 's' : ''} selected`;
  } else {
    bar.style.display = 'none';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Screenshot ‚Üí Extract Operator Names
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleScreenshotDrop(e) {
  e.preventDefault();
  document.getElementById('screenshotZone').classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) processScreenshot(file);
}

function handleScreenshotFile(e) {
  const file = e.target.files[0];
  if (file) processScreenshot(file);
}

async function processScreenshot(file) {
  const apiKey = document.getElementById('anthropicKey').value.trim();
  if (!apiKey) { showToast('Please enter your Anthropic API key first.', 'error'); return; }

  // Show preview
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = document.getElementById('screenshotPreview');
    img.src = e.target.result;
    img.style.display = 'block';
  };
  reader.readAsDataURL(file);

  // Convert to base64
  const base64 = await new Promise(res => {
    const r = new FileReader();
    r.onload = () => res(r.result.split(',')[1]);
    r.readAsDataURL(file);
  });

  document.getElementById('extractThinking').style.display = 'flex';
  document.getElementById('opList').innerHTML = '';
  const existingPanel = document.getElementById('unmatchedPanel');
  if (existingPanel) existingPanel.remove();

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: file.type, data: base64 } },
            { type: 'text', text: 'This is a screenshot from an aircraft operator database. Extract every operator/company name visible in this screenshot. Return ONLY a JSON array of strings with the operator names, nothing else. Example: ["OPERATOR ONE", "OPERATOR TWO"]' }
          ]
        }]
      })
    });
    const data = await response.json();
    let text = (data.content?.[0]?.text || '').replace(/```json|```/g, '').trim();
    const names = JSON.parse(text);
    matchAndSelectOperators(names);
    showToast(`Extracted ${names.length} operator names from screenshot`, 'success');
  } catch(e) {
    console.error(e);
    showToast('Failed to read screenshot: ' + e.message, 'error');
    renderOpList(visibleOperators);
  } finally {
    document.getElementById('extractThinking').style.display = 'none';
  }
}

function fuzzyMatch(name, query) {
  const n = name.toUpperCase().replace(/[^A-Z0-9]/g, '');
  const q = query.toUpperCase().replace(/[^A-Z0-9]/g, '');
  if (n === q) return 100;
  if (n.includes(q) || q.includes(n)) return 85;
  // Check word overlap
  const nWords = n.split(' ');
  const qWords = q.split(' ');
  const overlap = qWords.filter(w => w.length > 2 && nWords.some(nw => nw.includes(w) || w.includes(nw)));
  return overlap.length > 0 ? 60 + overlap.length * 10 : 0;
}

function matchAndSelectOperators(names) {
  blastSelected.clear();
  const matchedIndices = [];
  const unmatched = [];

  names.forEach(name => {
    let bestScore = 0, bestIdx = -1;
    OPERATORS.forEach((op, i) => {
      const score = fuzzyMatch(op.name, name);
      if (score > bestScore) { bestScore = score; bestIdx = i; }
    });
    if (bestScore >= 60 && bestIdx >= 0) {
      blastSelected.add(bestIdx);
      matchedIndices.push(bestIdx);
    } else {
      unmatched.push(name);
    }
  });

  visibleOperators = matchedIndices.length > 0 ? matchedIndices : OPERATORS.map((_, i) => i);
  renderOpList(visibleOperators);

  // Show missing operators below the list
  const existing = document.getElementById('unmatchedPanel');
  if (existing) existing.remove();

  if (unmatched.length > 0) {
    const panel = document.createElement('div');
    panel.id = 'unmatchedPanel';
    panel.style.cssText = 'margin-top:16px;padding:12px;background:rgba(255,79,79,0.08);border:1px solid rgba(255,79,79,0.3);border-radius:8px;';
    panel.innerHTML = `
      <div style="font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--danger);margin-bottom:8px;">
        ‚ö† ${unmatched.length} operator${unmatched.length > 1 ? 's' : ''} not found in master list
      </div>
      <div style="font-size:11px;color:var(--muted);line-height:1.8;">
        ${unmatched.map(n => `<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--danger);">‚úï</span> ${escHtml(n)}</div>`).join('')}
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,79,79,0.2);">
        These operators were in your screenshot but have no email in your master list. Consider adding them to your CSV.
      </div>`;
    document.getElementById('opListPane').appendChild(panel);
  }

  showToast(`Matched ${blastSelected.size} of ${names.length} operators`, blastSelected.size < names.length ? '' : 'success');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Build Blast Draft
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function buildBlastDraft() {
  if (blastSelected.size === 0) { showToast('Please select at least one operator.', 'error'); return; }

  const from = document.getElementById('blastFrom').value.trim();
  const to = document.getElementById('blastTo').value.trim();
  const date = document.getElementById('blastDate').value.trim();
  const pax = document.getElementById('blastPax').value.trim();
  const tripType = document.getElementById('blastTripType').value;
  const notes = document.getElementById('blastNotes').value.trim();

  // Get selected aircraft categories
  const cats = [...document.querySelectorAll('.aircraft-cat-cb:checked')].map(cb => cb.value);
  const catText = cats.length > 0 ? cats.join(', ') : 'Open to all categories';

  if (!from || !to || !date) { showToast('Please fill in departure, arrival, and date.', 'error'); return; }

  const tripLabel = tripType === 'round-trip' ? 'Round-Trip' : 'One-Way';

  const signature = `Garrett Mozingo
Owner & Founder
VALLEY JET
P: 480.658.6129
E: gmozingo@valleyjet.com
W: Valleyjet.com`;

  const emailBody = `Charter team,

We have a flight request from one of our clients and would appreciate your quote:

‚Ä¢ Trip Type: ${tripLabel}
‚Ä¢ Departure: ${from}
‚Ä¢ Arrival: ${to}
‚Ä¢ Date: ${date}
‚Ä¢ Passengers: ${pax || 'TBD'}
‚Ä¢ Aircraft Category: ${catText}${notes ? '\n‚Ä¢ Additional Notes: ' + notes : ''}

Thank you,

${signature}`;

  const subject = `Flight Request ‚Äì ${from} to ${to} | ${date}`;

  // Populate BCC
  const selectedOps = [...blastSelected].map(i => OPERATORS[i]);
  const bccEmails = selectedOps.map(o => o.email.trim()).filter(Boolean);
  const bccBox = document.getElementById('blastBccBox');
  bccBox.innerHTML = selectedOps.map(o => `<span class="bcc-tag">${escHtml(o.name)}</span>`).join('');
  document.getElementById('blastBccCount').textContent = `${bccEmails.length} operators ‚Ä¢ emails hidden from each other`;

  document.getElementById('blastSubject').value = subject;
  document.getElementById('blastBody').value = emailBody;
  document.getElementById('blastDraftOutput').style.display = 'block';
  document.getElementById('blastDraftEmpty').style.display = 'none';
  showToast('Outreach email ready!', 'success');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Send Blast Email
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendBlast() {
  if (!accessToken) { showToast('Please connect Outlook first.', 'error'); return; }
  const subject = document.getElementById('blastSubject').value.trim();
  const body = document.getElementById('blastBody').value.trim();
  const selectedOps = [...blastSelected].map(i => OPERATORS[i]);
  const bccEmails = [...new Set(selectedOps.map(o => o.email.trim()).filter(Boolean))];

  if (!bccEmails.length) { showToast('No operator emails to send to.', 'error'); return; }

  const sendBtn = document.querySelector('#blastDraftOutput .btn');
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<span class="spinner"></span> Sending...';

  try {
    await refreshToken();
    const message = {
      message: {
        subject,
        body: { contentType: 'Text', content: body },
        toRecipients: [{ emailAddress: { address: connectedEmail || 'charter@valleyjet.com' } }],
        bccRecipients: bccEmails.map(e => ({ emailAddress: { address: e } }))
      }
    };
    const res = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(message)
    });
    if (!res.ok) throw new Error(await res.text());
    showToast(`Sent to ${bccEmails.length} operators!`, 'success');
    sendBtn.innerHTML = `‚úì Sent to ${bccEmails.length} operators!`;
    setTimeout(() => { sendBtn.disabled = false; sendBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg> Send to All Operators'; }, 4000);
  } catch(e) {
    console.error(e);
    showToast('Send failed: ' + e.message, 'error');
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg> Send to All Operators';
  }
}

function copyBlastDraft() {
  const s = document.getElementById('blastSubject').value;
  const b = document.getElementById('blastBody').value;
  navigator.clipboard.writeText(`Subject: ${s}\n\n${b}`).then(() => showToast('Copied!', 'success'));
}
</script>
</body>
</html>
